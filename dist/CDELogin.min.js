/*! CDELogin 21-06-2015 */
var app=angular.module("CDELogin",[]);app.directive("cdeLogin",["CDEConstants","CDECache",function(a,b){return{link:function(c,d,e){a.bind(c),c.init({loginCallback:function(){c.User.access_token=b.get("access_token"),c.$apply()}}),c.$on("oauth",function(a,b){console.log("OAuth")}),c.$on("cauth",function(a,b){console.log("CAuth")}),c.$on("cstart",function(a,b){console.log("CAuth")})}}}]),app.controller("CDELoginCtrl",["$scope","CDESession","CDEControlBuffer",function(a,b,c){var d;a.init=function(e){c.bind(a),d=e,b.init({Scope:a,init_callback:function(){b.autoLogin("#",function(){void 0!==d.loginCallback&&d.loginCallback()})}})},a.login=function(){b.login(function(){void 0!==d.loginCallback&&d.loginCallback()})}}]),app.factory("CDEConstants",[function(){var a=function(a){a.LEFT_COL="file_nav_col",a.CENTER_COL="editor_col",a.RIGHT_COL="apps_col",a.EDITOR="editor_wrapper",a.ACTIVE_FILE="file_tab_active",a.INACTIVE_FILE="file_tab_inactive",a.Constants={EXEC_STATE_SLEEPING:0,EXEC_STATE_READY:1,EXEC_STATE_WAITING:2,EXEC_STATE_DEAD:3,T_USER:"user",T_DEMO:"demo",T_TEMP:"temp",T_INTRO:"intro",FILE_NAV_WRAPPER:"file_nav_wrapper",FILE_NAV_CONTAINER:"file_nav_container",OVERLAY:"black_screen",BACKGROUND:"background_div",THREE_COL:"3_col_split",EXEC_PROGRESSBAR:"exec-progress"},a.ADT={File:{id:void 0,name:void 0,path:void 0,rtime:void 0,wtime:void 0,etime:void 0,open:void 0},Commit:{offset:void 0,id:void 0,additions:"",deletions:"",style:void 0}}};return{bind:a}}]),app.factory("CDEControlBuffer",[function(){var a=function(a){a.App={active:!0,hostname:void 0,cde_path:void 0,production:void 0,client:void 0,display_mode:void 0},a.FireBase={Container:{collaborators:void 0,permission:void 0},FileSystem:{data:void 0}},a.Exec={display:!1,state:void 0,stdout:void 0,stderr:void 0,stdtest:void 0,history:[]},a.User={user_id:void 0,access_token:void 0,email:void 0,first_name:void 0,last_name:void 0,image:void 0,actions:[],permissions:{read:void 0,write:void 0,execute:void 0},ltime:void 0,errors:{lattempts:0,rattempts:0}},a.Container={name:void 0,permission:void 0,user:void 0,group:void 0},a.TabContent=[],a.Editor={tabs:a.TabContent,active:void 0,count:0},a.Mins={name:void 0},a.Statuses={auth:!1,apps:!1,container:!1,fnav:!1,signin:!1}};return{bind:a}}]),app.factory("CDEPath",[function(){var a="views/templates",b="resplendent-heat-459.firebaseio.com",c="http://localhost:3000";"cumulus.cs.ucdavis.edu"===location.hostname&&(c="http://cumulus.cs.ucdavis.edu");var d={file_nav_template:a+"/modules/fnav/file_nav_template.html",share_file_template:a+"/modules/fnav/overlay/share_file_template.html",import_file_template:a+"/modules/fnav/overlay/import_file_template.html",move_file_template:a+"/modules/fnav/overlay/move_file_template.html",snapshots_mins_template:a+"/modules/apps/snapshots_mins_template.html",git_template:a+"/modules/apps/git_template.html",settings_template:a+"/modules/apps/settings_template.html",search_file_template:a+"/modules/search_file_template.html",run_output_template:a+"/modules/editor/run_output_template.html",messages_template:a+"/modules/messages_template.html",CDE:"http://"+location.host+"/#/CDE"},e={rails_backend:c,compile_controller:c+"/compile/compile_file",start_container:c+"/containers/start_container",user_container_files:c+"/containers/get_user_files",delete_container_file:c+"/containers/delete_file",update_container_file:c+"/containers/update_file",rename_container_file:c+"/containers/rename_file",container_file_content:c+"/containers/file_content",download_container_file:c+"/containers/download_file",insert_container_file:c+"/containers/upload_file",create_container_file:c+"/containers/create_file",move_container_file:c+"/containers/move_file",stop_container:c+"/containers/stop_container",share_container_file:c+"/containers/share_container_file",copy_container_file:c+"/containers/copy_container_file",create_container_project:c+"/containers/create_project",start_temp_container:c+"/containers/start_temp_container",container_permission:c+"/containers/change_permission",add_container_member:c+"/containers/add_member",forK_container:c+"/containers/fork",content_controller:c+"/users/download_file",login_controller:c+"/users/create_user",update_user_tabs:c+"/users/set_user_tabs",get_user_tabs:c+"/users/get_user_tabs",send_message:c+"/messages/send_message",get_received_messages:c+"/messages/get_messages",get_sent_messages:c+"/messages/get_sent_messages",git_commit:c+"/git/commit",git_diff:c+"/git/diff",git_checkout:c+"/git/checkout",git_pull:c+"/git/clone",git_push:c+"/git/push",git_log:c+"/git/log",save_controller:"save_location"},f={firebase_root:b};return function(a){return void 0!=e[a]?e[a]:void 0!=d[a]?d[a]:void 0!=f[a]?f[a]:void 0}}]),app.factory("CDECache",["$rootScope","$cacheFactory",function(a,b){var c=!0,d=18e5,e=b("CDECache"),f=function(b){return i()||(h(),a.$broadcast("session-expire")),e.get(b)},g=function(b,c){i()||(h(),a.$broadcast("session-expire")),e.put(b,c)},h=function(){e.removeAll()},i=function(){var a=(new Date).getTime();return void 0===e.get("STime")&&e.put("STime",a),a-e.get("STime")<d?c:CDE_CACHE_STATUS_SUCCSS};return{get:f,put:g,clear:h}}]),app.factory("CDEHttp",["$rootScope","$http","CDECache","CDEWrite",function(a,b,c,d){var e=!0,f=!1,g={},h=function(a){var b=c.get("user_id"),d=c.get("access_token"),e=c.get("container"),f=c.get("type");(void 0==b||void 0==d)&&(user_uid="",d="");var g="?user_id="+b+"&access_token="+d,h=a+g;return void 0!=e&&void 0!=f&&(h=h+"&name="+e,h=h+"&type="+f),h},i=function(a,b){for(var c in b)a[c]=b[c]},j=function(a,b){for(var c in b)a+="&"+c+"="+b[c];return a},k=function(){var a=c.get("user_id"),b=c.get("access_token"),d=c.get("container"),e=c.get("type");if(void 0==a||void 0==b)return void 0;var f={user_id:a,access_token:b};return void 0!=d&&void 0!=e&&(f.name=d,f.type=e),f},l=function(a,c,e){try{g.debug_flag?b.get(c).success(function(a,b,c,d){void 0!==e&&e(a)}).error(function(b,c,e,f){d(b,"console",a)}):$.get(c).success(function(a){void 0!==e&&e(a)}).error(function(a,b,c){o(a.status)})}catch(f){}},m=function(a,c,e,f){try{g.debug_flag?b.post(c,e).success(function(a,b,c,d){void 0!==f&&f(a)}).error(function(b,c,e,f){d(b,"console",a)}):$.post(c,e).success(function(a){void 0!==f&&f(a)}).error(function(a,b,c){o(a.status)})}catch(h){}},n=function(a){return void 0===a?f:(g.debug_flag=a,e)},o=function(b){switch(b){case 400:a.$broadcast("cde.req-fault");case 401:a.$broadcast("cde.acc-fault")}};return{GetRequest:h,mergeParams:i,mergePath:j,PostParams:k,sendGetRequest:l,sendPostRequest:m,setDebugMode:n}}]),app.factory("CDEOut",[function(){var a="black_screen",b=!1,c=!0,d=!1,e={},f=function(a){return"object"!=typeof a?b:(void 0!==a.Production&&(d=a.Production),void(e.init=!0))},g=function(a,e){return void 0===e?b:(d||(void 0!==a?console.log(a+e):console.log(e)),c)},h=function(a,d){return void 0===d?b:(void 0===a?alert(d):alert(a+d),c)},i=function(){var b=$("#"+a);if(b.length)b.css("display","block");else{var c='<div id="'+a+'"></div>';$("body").append(c)}return $(document).on("keyup",function(a){27==a.which&&j()}),a},j=function(){var d=$("#"+a);return d.length?($(document).off("keyup"),d.empty(),d.css("display","none"),c):b},k=function(a,d){if(void 0===a)return b;var e=$("#"+a);if(!e.length)return b;if(0==d)return e.find(".progress").remove(),c;var f='<div class="progress progress-striped active" style="border-radius:1px; margin:0;"><div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="'+d+'" aria-valuemin="0" aria-valuemax="100"style="width: '+d+'%"><span class="sr-only">'+d+"% Complete</span></div></div>";return e.html(f),c},l=function(a){return void 0===a?b:(window.open(a,"_blank"),c)};return{init:f,console:g,alert:h,overlay:i,removeOverlay:j,progressbar:k,tab:l}}]),app.factory("CDEUtil",[function(){var a=function(a,b){var c=a.toLowerCase().charCodeAt(b),d="a".charCodeAt(0);return c-d},b=function(a,b){for(var c=0;b>c;++c)if(void 0===a[c])return!1;return!0},c=function(){var a=navigator.userAgent.search("Chrome"),b=navigator.userAgent.search("Firefox"),c=navigator.userAgent.search("MSIE 8.0"),d=navigator.userAgent.search("MSIE 9.0"),e=void 0;return a>-1?e="Chrome":b>-1?e="Firefox":d>-1?e="MSIE 9.0":c>-1&&(e="MSIE 8.0"),e},d=function(a){var b=a.substr(a.indexOf("?"));return"http://"+location.host+"/#/CDE"+b},e=function(a){for(var b in a)if("file_tab_active"==a[b].tab_class)return a[b];return void 0},f=function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.href);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))},g=function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;","\n":"<p>"};return a.replace(/[&<>"']/g,function(a){return b[a]})},h=function(a){var b={"<br/>":"\n","<br />":"\n","&amp;":"&","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};for(var c in b)a=a.replaceAll(b[c],c);return a},i=function(){return console.profile(),console.profileEnd(),console.clear&&console.clear(),console.profiles.length>0};return{alphaHash:a,argsNotUndefined:b,checkBrowser:c,convertUrl:d,getActiveTab:e,getParameter:f,htmlspecialchars_encode:g,htmlspecialchars_decode:h,isInspectOpen:i}}]),app.factory("CDEWrite",[function(){var a=1,b=function(){var a="black_screen",b=$("#"+a);b.css("display","block"),$(document).off("keyup"),$(document).on("keyup",function(a){27==a.which&&(b.empty(),b.css("display","none"))})};return function(c,d,e){var f={console:0,black_screen:1,alert:2,progressbar:3};if(void 0==f[d])return console.log("Unable to display the message!"),!1;switch(f[d]){case 0:void 0!=e&&(c=e+c),a&&console.log(c);break;case 1:return b(),OVERLAY;case 2:void 0!=e&&(c=e+c),alert(c);break;case 3:var g=$("#"+e);if(0==c)return g.find(".progress").remove(),!1;var h='<div class="progress progress-striped active" style="border-radius:1px; margin:0;"><div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="'+c+'" aria-valuemin="0" aria-valuemax="100"style="width: '+c+'%"><span class="sr-only">'+c+"% Complete</span></div></div>";g.html(h)}}}]),app.factory("GapiWrapper",["CDECache",function(a){var b=void 0,c=void 0,d={init:!1},e="https://apis.google.com/js/platform.js",f=void 0,g=void 0,h=void 0,i=function(a,f){$.getScript(e).done(function(e,g){b=a,void 0!==f.client_id&&void 0!==f.api_key?o(f.client_id,f.api_key):o(),void 0!==f.google_scopes?p(f.google_scopes):p(),c=void 0!==f.auth_callback?f.auth_callback:r,d.init=!0,void 0!==f.callback&&f.callback()}).fail(function(a,b,c){})},j=function(){if(!d.init)return!1;try{gapi.client.setApiKey(g),window.setTimeout(q,1)}catch(a){}},k=function(a){return d.init?(gapi.auth.authorize({client_id:f,scope:h,immediate:!1,cookie_policy:"single_host_origin",response_type:"token id_token"},c),!1):!1},l=function(){return h},m=function(){return GapiStatues},n=function(b,c){$.ajax({url:"http://www.google.com/m8/feeds/contacts/default/full?access_token="+a.get("gapi-tok")+"&max-results=999",jsonp:"callback",dataType:"jsonp",success:function(a){var b=[],d=[];if(window.DOMParser)var e=new DOMParser,b=e.parseFromString(a,"text/xml");else{var b=new ActiveXObject("Microsoft.XMLDOM");b.async=!1,b.loadXML(a)}var f=b.getElementsByTagName("entry");for(var g in f){var h=f[g].lastChild;if(void 0!=h){var i=h.getAttribute("address");if(void 0!=i){var j=f[g].childNodes[3],k=j.textContent;d.push(k+" ("+i+")")}}}void 0!=c&&c(d)}})},o=function(a,c){void 0!==a&&void 0!==c?(f=a,g=c):b.App.production?(f="261784489223-v1gi00vigpfs7aodkbiilk36k8dlje4j.apps.googleusercontent.com",g="AIzaSyAjFkR8Unwd_Kt5BXZ4MpSWjTCzxxb52G4"):(f="344688152776-bvj201ldvethrpafcshg42q6nuhdimga.apps.googleusercontent.com",g="AIzaSyCj5ySyY4SDehx0d-SG4NCF6ICQDyr14Uo")},p=function(a){var b="https://www.googleapis.com/auth/userinfo.profile ",c="https://www.googleapis.com/auth/userinfo.email ",d="https://www.googleapis.com/auth/contacts.readonly";h=void 0!==a?a:b+c+d},q=function(){gapi.auth.authorize({client_id:f,scope:h,immediate:!0,cookie_policy:"single_host_origin"},c)},r=function(){return!1};return{init:i,handleAuthClick:k,handleClientLoad:j,getStatuses:m,getScopes:l,getContacts:n}}]),app.factory("login",["$rootScope","CDEPath","CDEWrite","CDEUtil","CDECache",function(a,b,c,d,e){return function(c,f,g,h){if(0!=d.getParameter("name").length){var i=d.getParameter("name");sessionStorage.setItem("container",i),e.put("container",i)}if(0!=d.getParameter("type").length){var j=d.getParameter("type");sessionStorage.setItem("type",j),e.put("type",j)}if(void 0===f)return e.put("user_id",""),e.put("access_token",""),localStorage.setItem("user_id",""),localStorage.setItem("access_token",""),a.$broadcast("cauth",{uid:"",access_token:""}),void 0!==h&&h(),!1;var k=f.split(" ");$.post(b("login_controller"),{user_id:c,first_name:k[0],last_name:k[k.length-1],email:g},function(b){sessionStorage.clear(),e.put("access_token",b.replace(/"/g,"")),e.put("user_id",c),localStorage.setItem("access_token",b.replace(/"/g,"")),localStorage.setItem("user_id",c),a.$broadcast("cauth",{uid:c,access_token:b.replace(/"/g,"")}),void 0!==h&&h(b)})}}]),app.factory("start_container",["CDEPath","CDEWrite","CDEUtil",function(a,b,c){return function(b,d,e,f){var g=void 0,h=void 0;if(void 0==b&&(b=""),void 0==d&&(d=""),void 0==e&&(e=""),""!==c.getParameter("type")&&(g=c.getParameter("type")),""!==c.getParameter("name")&&(h=c.getParameter("name")),void 0!==g&&void 0!==h)var i={id:b,etag:d,email:e,type:g,name:h};else var i={id:b,etag:d,email:e};$.post(a("start_container"),i,function(a){void 0!=f&&f(a)})}}]),app.factory("CDEAuth",["$rootScope","CDECache","GapiWrapper","start_container","login",function(a,b,c,d,e){var f=!0,g=!1,h=void 0,i=void 0,j=void 0,k=void 0,l=void 0,m=function(a,b){h=a,i={},l={},j={init:!0,auth:!1},k=void 0===b?{}:b,void 0!==k.init_callback&&k.init_callback()},n=function(a){return j.init?(l.GoogleAuth=a,void c.init(h,{auth_callback:q,callback:function(){c.handleAuthClick(h)}})):!1},o=function(a){return j.init?(c.init(h,{auth_callback:q,callback:c.handleClientLoad}),void(l.GoogleAuth=a)):!1},p=function(){return j.init?void 0===h.App.hostname?g:(h.Statuses.signin=!1,localStorage.clear(),sessionStorage.clear(),gapi.auth.signOut(),void setInterval(function(){window.location.replace(h.App.hostname)},1500)):g},q=function(c){b.put("gapi-tok",c.access_token),gapi.client.load("plus","v1",function(){var b=gapi.client.plus.people.get({userId:"me"});b.execute(function(b){try{i.id=b.id,i.etag=b.etag,i.email=b.emails[0].value,i.name=b.displayName,i.image=b.image.url,a.$broadcast("oauth",{email:i.email,name:i.name,image:i.image})}catch(c){}r(function(a){void 0!==l.GoogleAuth&&l.GoogleAuth(),s(a)})})})},r=function(a){e(i.id,i.name,i.email,function(b){void 0!==a&&a(b)})},s=function(){return h.Statuses.container?g:(d(i.id,i.etag,i.email,function(b){a.$broadcast("cstart",b)}),f)};return{init:m,loginWithGoogle:n,checkGoogleLogin:o,logoutWithGoogle:p}}]),app.factory("CDEFirebase",["$rootScope","CDEWrite",function(a,b){var c="https://resplendent-heat-459.FireBaseio.com/",d=!1,e=void 0,f={},g=function(a){return"object"!=typeof a?d:(e=a.Scope,j(e.FireBase),k(e.Container),void(f.init=!0))},h=function(a,b){a.once("value",function(a){b.set(a.value(),function(a){a&&"undefined"!=typeof console&&console.error&&console.error(a)})})},i=function(){oldRef.once("value",function(a){newRef.set(a.value(),function(a){a?"undefined"!=typeof console&&console.error&&console.error(a):oldRef.remove()})})},j=function(a){var b=c+e.Container.name;for(var d in a){var f=a[d];if("object"==typeof f)for(var g in f){var h=b+"/"+d+"/"+g;a[d][g]=new Firebase(h)}else{var h=b+"/"+d;a[d]=new Firebase(h)}}},k=function(b){var c=e.FireBase.Container,d=e.FireBase.FileSystem;c.permission.on("value",function(c){b.permission=c.val(),a.$broadcast("permission-change")}),c.collaborators.on("value",function(c){b.group=l(c),a.$broadcast("collaborator-change",c)}),d.data.on("value",function(b){var c=b.val();a.$broadcast("fnav.new_data",c)})},l=function(a){var b=a.val(),c=[];return null===b?c:(a.forEach(function(a){var b=a.val();return 0==b.length?!1:void c.push(JSON.parse(b))}),c)};return{init:g,copy:h,move:i}}]),app.factory("CDESession",["CDEWrite","CDEUtil","CDECache","CDEAuth",function(a,b,c,d){var e=!0,f=!1,g=void 0,h=void 0,i={init:!1,auth:!1},j=function(a){return h="http://"+location.host+"/#/CDE",g=void 0===a.Scope?{}:a.Scope,void 0===g.Statuses&&(g.Statuses={}),n(g),d.init(g),o(g),i.init=!0,void 0!==a.init_callback&&a.init_callback(),e},k=function(a){d.loginWithGoogle(function(){void 0!==a&&a()})},l=function(a,b){return i.init?void d.checkGoogleLogin(function(){var d="#"===a,e=location.href===h;-1!=location.href.indexOf(h)&&(a=location.href),(!d||e)&&window.location.replace(a),void 0!==b&&b(),"intro"===c.get("c_demo")&&introJs().start()}):f},m=function(){d.logoutWithGoogle()},n=function(a){a.App.hostname=location.hostname,a.App.client=a.Constants.T_USER,"localhost"===a.App.hostname&&(a.App.hostname="http://localhost:9000"),"cumulus.cs.ucdavis.edu"===a.App.hostname?(a.App.hostname="http://cumulus.cs.ucdavis.edu",a.App.production=!0):(a.App.hostname="http://localhost:9000",a.App.production=!1),a.App.cde_path=h,a.Container.name=b.getParameter("name"),-1==location.href.indexOf(h)?a.App.active=!1:a.App.active=!0},o=function(a){var d=b.getParameter("type"),e=b.getParameter("name"),f=b.getParameter("p");c.put("c_type",d),c.put("c_name",e),c.put("c_demo",f),0!=e.length&&0!=d.length&&(sessionStorage.type=b.getParameter("type"),sessionStorage.container=b.getParameter("name"),"demo"===b.getParameter("p")?(a.App.client=a.Constants.T_DEMO,localStorage.setItem("user_id","demo"),localStorage.setItem("access_token","pass")):(a.App.client=a.Constants.T_TEMP,a.Statuses.signin||(localStorage.setItem("user_id","temp"),localStorage.setItem("access_token","pass"))))};return{init:j,autoLogin:l,login:k,logout:m}}]);